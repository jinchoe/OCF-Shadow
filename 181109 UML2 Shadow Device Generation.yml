@startuml

title __Shadow Device Generation__

|||

participant "Original Device"
participant "Shadow Generation \nResource" 
participant "Shadow Device" 
box "Shadow Service" #White
participant "Shadow Generation \nResource"
participant "Shadow Device"
end box

== 2.1) Request to generate a Shadow Device == 

note over "Original Device", "Shadow Generation \nResource" #Aqua
Original Device sends a Request to "oic.wk.shadow.gen" hosted in 
the Shadow Service to generate its Shadow Device

It supplies all Resources to be synchronized in the payload of this
request
endnote  

"Original Device" -> "Shadow Generation \nResource": POST /oic/shadow/gen  

note right of "Original Device" #ivory
{
   "di": "Original_Device_ID",
   "ttl": 600,
   "sre": ["coaps://[fe80::b1e6]:55555"],
   "dre": ["coaps://[fe80::b1e6]:55555"],
   "resources": [
     {
       "href": "/temperature",
       "p": {"bm": 1},
       "rep": {
         "rt": ["oic.r.temperature"],
         "if": ["oic.if.a", "oic.if.baseline"],
         "temperature": 20,
         "units": "C"
       }
       "timestamp": 11240000111
     },
     {
       "href": "/atmospheric_pressure",
       "p": {"bm": 1},
       "rep": {
         "rt": ["oic.r.sensor.atmosphericpressure"],
         "if": ["oic.if.s", "oic.if.baseline"],
         "atmosphericPressure": 1000.4,
         "units": "hPa"
       }
       "timestamp": 11240000100
     },
     {
       "href": "/oic/d",
       "p": {"bm": 1},
       "rep": {
         "rt": ["oic.wk.d", "oic.d.sensor"],
         "if": ["oic.if.s", "oic.if.baseline"],
         "di": "Original_Device_ID",
         "icv": "ocf.2.0.0",
         "dmv": "ocf.res.1.0.0",
         "dmn": "foo labs",
         "dmno": "bar product xxx"
       }
       "timestamp": 11240000050
     }
   ]
}
endnote 

note over "Original Device", "Shadow Generation \nResource" #Aqua
"timestamp" for each Resource is a record of the actual time that
their respected states were recorded
endnote  

"Shadow Generation \nResource" <-> "Shadow Device": Internal processing to create a Shadow Device  

note over "Shadow Generation \nResource", "Shadow Device" 
Shadow Service constructs a Shadow Device containing the Resources in
the payload as well as mandatory Resources for OCF devices, also
including "oic.wk.shadow.sync" and "oic.wk.shadow.info"
endnote 

note right of "Shadow Device"
The newly created Shadow Device has "oic.wk.shadow.info" populated as below
endnote 

note right of "Shadow Device" #ivory
{
  "rt": ["oic.wk.shadow.info"],
  "if": ["oic.if.rw", "oic.if.baseline"],
  "odi": "Original_Device_ID",
  "ode": ["coaps://[fe80::b1e6]:55555"],
  "isSynched": false
  "lastSyncTimestamp": 1124000111
}
endnote 

note right of "Shadow Device" #Aqua
lastSyncTimestamp reflects the timestamp of the most recent state
of a resource in the list of all synched resources provided in the
request to /oic/shadow/gen

In the example above, lastSyncTimestamp is initialized to timestamp
of /tenperature
endnote 

== 2.2) Response from /oic/shadow/gen == 

note over "Original Device", "Shadow Device" #Aqua
Shadow Service returns a Response with the Links 
to "oic.wk.shadow.sync" and "oic.wk.res" on the Shadow Device
endnote  

"Shadow Generation \nResource" --> "Original Device": Response: Created with the payload 

note left of "Shadow Generation \nResource" #ivory 
[
  { "href": "/oic/shadow/sync",
    "anchor": "ocf://Shadow_Device_di",
    "rt": ["oic.wk.shadow.sync"],
    "if": ["oic.if.rw", "oic.if.baseline"],
    "p": {"bm": 0},
    "eps": [{"ep": "coaps://[fe80::b1d6]:4444"}]
  },
  { "href": "/oic/res",
    "anchor": "ocf://Shadow_Device_di",
    "rt": ["oic.wk.res"],
    "if": ["oic.if.r", "oic.if.baseline"],
    "p": {"bm": 3},
    "eps": [{"ep": "coaps://[fe80::b1d6]:2222"}]
  }
]
endnote 

note left of "Original Device"
Upon receiving the Response, the original Device updates
its "oic.wk.shadow.conf" as below:
endnote 

note left of "Original Device" #ivory 
{
   "rt": ["oic.wk.shadow.conf"],
   "if": ["oic.if.rw", "oic.if.baseline"],
   "si": "Shadow_Service_ID",
   "sgr": "coaps://[fe80::b1d6]:1111/oic/shadow/gen",
   "sgi": true,
   "sdi": "Shadow_Device_ID",     
   "sde": ["coaps://[fe80::b1d6]:2222"],
   "isSynched": false,     
   "lastSyncTimestamp": 1124000111
}
endnote 
 
note over "Original Device", "Shadow Device" #Aqua
The Shadow Device Endpoint (sde) property is set to the ep of the
/oic/res resource in the Shadow Device

The Original Device sets lastSyncTimestamp to reflect the most
recent timestamp among all synchronized resources provided in the
request to /oic/shadow/gen

URI of the Shadow Device's /oic/shadow/sync resource
is stored internally in a Synchronization Table data structure on the
Original Device
endnote

note over "Original Device", "Shadow Device" #Aqua
Original Device generated its Shadow Device and is ready for synchronization
endnote 

@enduml